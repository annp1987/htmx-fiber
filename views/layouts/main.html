<!DOCTYPE html>
<html lang="en" class="h-full bg-white">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .Page }} - Go HTMX App</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body class="bg-gray-100 font-sans">
<nav class="bg-blue-600 p-4 shadow-md">
    <div class="container mx-auto flex justify-between items-center">
        <h1 class="text-white text-xl font-bold">Dashboard</h1>
        <ul class="flex space-x-4 text-white">
            <li>
                <a href="/" class="hover:bg-blue-700 px-3 py-2 rounded-md transition-colors {{ if eq .Page "home" }}font-bold bg-blue-700{{ end }}">Home</a>
            </li>
            <li>
                <a href="/books" class="hover:bg-blue-700 px-3 py-2 rounded-md transition-colors {{ if eq .Page "books" }}font-bold bg-blue-700{{ end }}">Books</a>
            </li>
            <li>
                <a href="/accounts" class="hover:bg-blue-700 px-3 py-2 rounded-md transition-colors {{ if eq .Page "accounts" }}font-bold bg-blue-700{{ end }}">Accounts</a>
            </li>
        </ul>
    </div>
</nav>
<div class="container mx-auto p-4">
    {{embed}}
</div>

<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/sse.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<script>
    // This function tells HTMX to fetch the button and put it back in its container
    function restoreProcessButton() {
        // Small delay to allow the user to see the final progress message before it's replaced
        setTimeout(function() {
            htmx.ajax('GET', '/books/process-button', {
                target: '#process-books-container',
                swap: 'innerHTML'
            });
        }, 500); // 500ms delay
    }

    document.body.addEventListener('htmx:sseMessage', function(event) {
        console.log("received event: ", event);
        const message = event.detail.data;

        console.log("received message: ", message);
        if (!message) return;

        const eventType = event.detail.type;

        switch (eventType) {
            case 'complete':
                // 1. Show success notification
                Toastify({
                    text: message,
                    duration: 5000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    style: {
                        background: "linear-gradient(to right, #00b09b, #96c93d)",
                    }
                }).showToast();
                // 2. Restore the button
                restoreProcessButton();
                break;
            case 'error':
                // 1. Show error notification
                Toastify({
                    text: message,
                    duration: 5000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    style: {
                        background: "linear-gradient(to right, #ff5f6d, #ffc371)",
                    }
                }).showToast();
                // 2. Restore the button
                restoreProcessButton();
                break;
            default:
                Toastify({
                    text: message,
                    duration: 5000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    style: {
                        background: "linear-gradient(to right, #00b09b, #96c93d)",
                    }
                }).showToast();
        }
    });
</script>

</body>
</html>